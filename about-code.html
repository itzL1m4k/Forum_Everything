<!DOCTYPE html>
<html lang="pl-PL">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="./assets/img/ikona-strony.png" type="image/x-icon" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/global-styles.css" />
    <link rel="stylesheet" href="./assets/prism/prism.css" />
    <title>Forum | Kod Skryptów</title>
  </head>

  <body>
    <button id="to-top-btn" onclick="scrollToTop()">
      <img id="arrow-up" src="./assets/img/arrow-up-solid.svg" alt="strzałka do góry" />
    </button>

    <div class="container">
      <section class="logo">
        <h1><a href="index.php">Forum Informatyczne</a></h1>
      </section>

      <header>
        <ul>
          <li><a href="index.php">Wpisy</a></li>
          <li><a href="documentation.html">Dokumentacja</a></li>
          <li><a href="about-code.html">Kod PHP</a></li>
          <li><a href="about-code2.html">Kod JavaScript</a></li>
        </ul>
        <ul>
          <li class="login-nav"><a href="login.php">Zaloguj się</a></li>
          <li class="login-nav"><a href="register.php">Zarejestruj się</a></li>
          <li class="yourAccount hidden">
            <a href="profile-data.php">Twoje konto</a>
          </li>
        </ul>
      </header>

      <main>
        <section id="navbar-code">
          <ul>
            <li><a class="scroll-link" href="#sekcja1">indexPhp</a></li>
            <li><a class="scroll-link" href="#sekcja2">addComment</a></li>
            <li><a class="scroll-link" href="#sekcja3">checkSession</a></li>
            <li><a class="scroll-link" href="#sekcja4">deleteComment</a></li>
            <li><a class="scroll-link" href="#sekcja5">deletePost</a></li>
            <li><a class="scroll-link" href="#sekcja6">editComment</a></li>
            <li><a class="scroll-link" href="#sekcja7">editPost</a></li>
            <li><a class="scroll-link" href="#sekcja8">loginUser</a></li>
            <li><a class="scroll-link" href="#sekcja9">newPost</a></li>
            <li><a class="scroll-link" href="#sekcja10">registerUser</a></li>
            <li><a class="scroll-link" href="#sekcja11">resetPass</a></li>
            <li><a class="scroll-link" href="#sekcja12">saveData</a></li>
            <li><a class="scroll-link" href="#sekcja13">deleteAccount</a></li>
          </ul>
        </section>

        <div class="code-script-all">
          <section class="post" id="sekcja1">
            <h2>Cały skrypt w pliku index.php</h2>
            <pre>
            <code class="language-php">
require_once("../php/connect.php");

session_start();
$currentUserId = isset($_SESSION['user_id']) ? $_SESSION['user_id'] : null;

$order = isset($_POST['order']) ? $_POST['order'] : 'DESC';
$showPostsOption = isset($_POST['show-posts']) ? $_POST['show-posts'] : '';
$showUserPosts = $showPostsOption === 'mine';
$showAllPosts = $showPostsOption === 'all';
$whereClause = '';

if ($showUserPosts && $currentUserId !== null && !$showAllPosts) {
  $whereClause = " WHERE wpisy.autor_id = $currentUserId";
}

$sql = "SELECT wpisy.*, uzytkownicy.nickname FROM wpisy JOIN uzytkownicy ON wpisy.autor_id
 = uzytkownicy.user_id" . $whereClause . " ORDER BY wpisy.data_publikacji $order";

$result = mysqli_query($conn, $sql);

if (mysqli_num_rows($result) &gt; 0) {

  $rows = mysqli_fetch_all($result, MYSQLI_ASSOC);

  echo '&lt;form class="form-bg" method="post" action=""&gt;';
  echo '&lt;label for="order"&gt;Sortuj według &lt;/label&gt; ';
  echo '&lt;select name="order" id="order" onchange="this.form.submit()"&gt;';
  echo '&lt;option value="DESC" ' . ($order === 'DESC' ? 'selected' : '') . '&gt;Najnowszych&lt;/option&gt;';
  echo '&lt;option value="ASC" ' . ($order === 'ASC' ? 'selected' : '') . '&gt;Najstarszych&lt;/option&gt;';
  echo '&lt;/select&gt;';

  echo '&lt;label for="show-posts"&gt;Pokaż posty &lt;/label&gt;';
  echo '&lt;select name="show-posts" id="show-posts" onchange="this.form.submit()"&gt;';
  echo '&lt;option value="mine" ' . ($showUserPosts ? 'selected' : '') . '&gt;Moje&lt;/option&gt;';
  echo '&lt;option value="all" ' . ($showAllPosts ? 'selected' : '') . '&gt;Wszystkie&lt;/option&gt;';
  echo '&lt;&lt;/select&gt;';

  echo '&lt;/form&gt;';

  foreach ($rows as $row) {
    echo "&lt;div class='post-section'&gt;";
    echo "&lt;h2&gt;" . $row["tytul"] . "&lt;/h2&gt;";
    echo "&lt;p&gt;&lt;strong&gt;Autor:&lt;/strong&gt; " . $row["nickname"] . "&lt;/p&gt;";
    echo "&lt;p&gt;" . $row["tresc"] . "&lt;/p&gt;";
    echo "&lt;p&gt;&lt;strong&gt;Data publikacji:&lt;/strong&gt; " . $row["data_publikacji"] . "&lt;/p&gt;";

    if ($currentUserId !== null && $row["autor_id"] === $currentUserId) {
      echo "&lt;button class='edit-any'&gt;&lt;a href='./php/edit-post.php?id=" . $row["id"] . "'&gt;Edytuj&lt;/a&gt;&lt;/button&gt;";
      echo "&lt;button class='edit-any' onclick='deletePost(" . $row["id"] . ")'&gt;Usuń&lt;/button&gt;";
    }

    echo "&lt;script&gt;
    function deletePost(postId) {
        Swal.fire({
            title: 'Czy na pewno chcesz usunąć ten post?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Tak, usuń',
            cancelButtonText: 'Anuluj',
            customClass: {
                popup: 'my-custom-popup-class',
                title: 'my-custom-title-class',
                content: 'my-custom-content-class',
                confirmButton: 'my-custom-button-class',
                cancelButton: 'my-custom-button-class',
            },
        }).then((result) =&gt; {
            if (result.isConfirmed) {
                window.location.href = './php/delete-post.php?id=' + postId;
            }
        });
    }
    &lt;/script&gt;";


    echo "&lt;/div&gt;";
    echo "&lt;div class='title-comment'&gt;&lt;h3&gt;Komentarze&lt;/h3&gt;&lt;/div&gt;";

    $comments_sql = "SELECT komentarze.*, uzytkownicy.nickname FROM komentarze JOIN
     uzytkownicy ON komentarze.autor_id = uzytkownicy.user_id WHERE
      wpis_id = " . $row["id"] . " ORDER BY komentarze.data_publikacji DESC";

    $comments_result = mysqli_query($conn, $comments_sql);

    echo '&lt;div class="comment-add comment-add-' . $row["id"] . ' hidden"&gt;';
    echo '&lt;form method="POST" action="./php/add-comment.php"&gt;';
    echo '&lt;input type="hidden" name="wpis_id" value="' . $row["id"] . '"&gt;';
    echo '&lt;textarea name="tresc" required placeholder="Napisz swoją opinie na temat tego postu!"&gt;&lt;/textarea&gt;';
    echo '&lt;br&gt;';
    echo '&lt;input type="submit" value="Dodaj komentarz"&gt;';
    echo '&lt;/form&gt;';
    echo '&lt;/div&gt;';

    if (mysqli_num_rows($comments_result) &gt; 0) {

      while ($comment_row = mysqli_fetch_assoc($comments_result)) {

        echo "&lt;div class='comment hidden' data-post-id='" . $row["id"] . "'&gt;";
        echo "&lt;p&gt;&lt;strong&gt;Autor:&lt;/strong&gt; " . $comment_row["nickname"] . "&lt;/p&gt;" . "&lt;br&gt;";
        echo "&lt;p&gt;" . $comment_row["tresc"] . "&lt;/p&gt;" . "&lt;br&gt;";
        echo "&lt;p&gt;&lt;strong&gt;Data publikacji:&lt;/strong&gt; " . $comment_row["data_publikacji"] . "&lt;/p&gt;";

        if ($currentUserId !== null && $row["autor_id"] === $currentUserId) {
          echo "&lt;button class='edit-any'&gt;&lt;a href='./php/edit-comment.php?id=" . $comment_row["id"] . "'&gt;Edytuj&lt;/a&gt;&lt;/button&gt;";
          echo "&lt;button class='edit-any' onclick='deleteComment(" . $comment_row["id"] . ")'&gt;Usuń&lt;/button&gt;";
        }

        echo "&lt;script&gt;
        function deleteComment(commentId) {
            Swal.fire({
                title: 'Czy na pewno chcesz usunąć ten post?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Tak, usuń',
                cancelButtonText: 'Anuluj',
                customClass: {
                    popup: 'my-custom-popup-class',
                    title: 'my-custom-title-class',
                    content: 'my-custom-content-class',
                    confirmButton: 'my-custom-button-class',
                    cancelButton: 'my-custom-button-class',
                },
            }).then((result) =&gt; {
                if (result.isConfirmed) {
                    window.location.href = './php/delete-comment.php?id=' + commentId;
                }
            });
        }
        &lt;/script&gt;";
        echo "&lt;/div&gt;";
      }
    }
    echo '&lt;button class="show-comments" data-post-id="' . $row["id"] . '"&gt;Pokaż komentarze&lt;/button&gt;';

    echo "&lt;hr&gt;";
  }
} else {
  echo "&lt;div class='non-posts'&gt;";
  echo "&lt;span class='message-posts'&gt;Nie ma żadnych wpisów :c&lt;/span&gt;";
  echo "&lt;/div&gt;";
}
mysqli_close($conn);
            </code>
          </pre>
          </section>
          <br />
          <br />
          <section class="post" id="sekcja2">
            <h2>Dodawanie komentarza</h2>
            <pre>
            <code class="language-php">
require_once("../php/connect.php");

session_start();
$autor_id = $_SESSION['user_id'];
$wpis_id = $_POST['wpis_id'];
$tresc = $_POST['tresc'];

$result = mysqli_query($conn, "INSERT INTO komentarze (autor_id, wpis_id, tresc) VALUES ($autor_id, $wpis_id, '$tresc')");

if ($result) {
  header('Location: notify.php?info=comment_added');
  exit;
} else {
  header('Location: notify.php?info=comment_error');
  exit;
}
mysqli_close($conn);

            </code>
          </pre>
          </section>
          <br />
          <br />
          <section class="post" id="sekcja3">
            <h2>Sprawdzanie sesji</h2>
            <pre>
            <code class="language-php">
if (session_status() == PHP_SESSION_NONE) {
  session_start();
}
$response = ['login' =&gt; (isset($_SESSION['login']) && $_SESSION['login'] === true)];

header('Content-Type: application/json');
echo json_encode($response);

            </code>
          </pre>
          </section>
          <br />
          <br />
          <section class="post" id="sekcja4">
            <h2>Usuwanie komentarza</h2>
            <pre>
            <code class="language-php">
require_once("../php/connect.php");

if (isset($_GET['id'])) {
  $comment_id = $_GET['id'];

  $check_query = "SELECT * FROM komentarze WHERE id = '$comment_id'";
  $check_result = mysqli_query($conn, $check_query);

  if (mysqli_num_rows($check_result) &gt; 0 && mysqli_query($conn, "DELETE FROM komentarze WHERE id = '$comment_id'")) {
    header('Location: notify.php?info=comment_deleted');
  } else {
    header('Location: notify.php?info=delete_error');
  }
} else {
  header('Location: notify.php?info=invalid_request');
}

mysqli_close($conn);
exit;

            </code>
          </pre>
          </section>
          <br />
          <br />
          <section class="post" id="sekcja5">
            <h2>Usuwanie posta</h2>
            <pre>
            <code class="language-php">
require_once("../php/connect.php");

if (isset($_GET['id'])) {
  $post_id = $_GET['id'];

  $check_query = "SELECT * FROM wpisy WHERE id = '$post_id'";
  $check_result = mysqli_query($conn, $check_query);

  if (mysqli_num_rows($check_result) &gt; 0) {

    $delete_comments_query = "DELETE FROM komentarze WHERE wpis_id = '$post_id'";
    if (mysqli_query($conn, $delete_comments_query)) {

      $delete_query = "DELETE FROM wpisy WHERE id = '$post_id'";
      if (mysqli_query($conn, $delete_query)) {
        header('Location: notify.php?info=post_deleted');
        exit;
      } else {
        header('Location: notify.php?info=delete_error-post');
        exit;
      }
    } else {
      header('Location: notify.php?info=delete_error-comments');
      exit;
    }
  } else {
    header('Location: notify.php?info=post_not_found');
    exit;
  }
} else {
  header('Location: notify.php?info=invalid_request');
  exit;
}
mysqli_close($conn);

            </code>
          </pre>
          </section>
          <br />
          <br />
          <section class="post" id="sekcja6">
            <h2>Edytowanie komentarza</h2>
            <pre>
            <code class="language-php">
if (isset($_GET['id'])) {
  $postId = $_GET['id'];

  if (isset($_POST['tresc'])) {
    $tresc = $_POST['tresc'];
    require_once("../php/connect.php");

    $updateSql = "UPDATE komentarze SET tresc = '$tresc' WHERE id = $postId";
    $updateResult = mysqli_query($conn, $updateSql);

    if ($updateResult) {
      header("Location: index.php");
      exit();
    } else {
      echo "Wystąpił błąd podczas aktualizacji komentarza.";
    }
  }

  require_once("../php/connect.php");

  $selectSql = "SELECT * FROM komentarze WHERE id = $postId";
  $result = mysqli_query($conn, $selectSql);

  if ($result && mysqli_num_rows($result) &gt; 0) {
    $row = mysqli_fetch_assoc($result);
    $tresc = $row['tresc'];
  } else {
    echo "komentarz o podanym identyfikatorze nie istnieje.";
  }
  mysqli_close($conn);
} else {
  echo "Nieprawidłowy identyfikator komentarza.";
}
?&gt;
            </code>
          </pre>
          </section>
          <br />
          <br />
          <section class="post" id="sekcja7">
            <h2>Edytowanie posta</h2>
            <pre>
            <code class="language-php">
if (isset($_GET['id'])) {
  $postId = $_GET['id'];

  if (isset($_POST['tytul']) && isset($_POST['tresc'])) {
    $tytul = $_POST['tytul'];
    $tresc = $_POST['tresc'];

    require_once("../php/connect.php");

    if (isset($_FILES['post-image']) && $_FILES['post-image']['error'] === UPLOAD_ERR_OK) {
      $obrazek_data = file_get_contents($_FILES['post-image']['tmp_name']);
      $obrazek_data = mysqli_real_escape_string($conn, $obrazek_data);

      $updateSql = "UPDATE wpisy SET tytul = '$tytul', tresc = '$tresc', obrazek = '$obrazek_data' WHERE id = $postId";
    } else {
      $updateSql = "UPDATE wpisy SET tytul = '$tytul', tresc = '$tresc' WHERE id = $postId";
    }

    $updateResult = mysqli_query($conn, $updateSql);

    if ($updateResult) {
      header("Location: index.php");
      exit();
    } else {
      echo "Wystąpił błąd podczas aktualizacji postu.";
    }
  }

  require_once("../php/connect.php");

  $selectSql = "SELECT * FROM wpisy WHERE id = $postId";
  $result = mysqli_query($conn, $selectSql);

  if ($result && mysqli_num_rows($result) &gt; 0) {
    $row = mysqli_fetch_assoc($result);
    $tytul = $row['tytul'];
    $tresc = $row['tresc'];
  } else {
    echo "Post o podanym identyfikatorze nie istnieje.";
  }
  mysqli_close($conn);
} else {
  echo "Nieprawidłowy identyfikator postu.";
}
?&gt;
            </code>
          </pre>
          </section>
          <br />
          <br />
          <section class="post" id="sekcja8">
            <h2>Logowanie użytkownika</h2>
            <pre>
            <code class="language-php">
require_once("../php/connect.php");

$email = $_POST['email'];
$password = $_POST['password'];
$rememberMe = $_POST['rememberMe'];

if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
  header("Location: login.php?error=invalid_email");
}

$result = mysqli_query($conn, "SELECT * FROM uzytkownicy WHERE email = '$email'");

if (mysqli_num_rows($result) == 1) {
  $row = mysqli_fetch_assoc($result);

  if (password_verify($password, $row['haslo'])) {
    startSession();
    setSessionVariables($row);
    if ($rememberMe) {
      setRememberMeCookie();
    }
    header("Location: index.php");
    exit;
  }
}

header("Location: login.php?error=login_failed");
exit;

function startSession()
{
  if (session_status() === PHP_SESSION_NONE) {
    session_start();
  }
  $_SESSION['login'] = true;
}

function setSessionVariables($row)
{
  $_SESSION['user_id'] = $row['user_id'];
  $_SESSION['nickname'] = $row['nickname'];
}

function setRememberMeCookie()
{
  $token = bin2hex(random_bytes(16));
  setcookie('login_cookie', $token, time() + 3600 * 7, '/');
}

            </code>
          </pre>
          </section>
          <br />
          <br />
          <section class="post" id="sekcja9">
            <h2>Nowy post</h2>
            <pre>
            <code class="language-php">
require_once("../php/connect.php");

if (isset($_POST['post-title'], $_POST['post-content'])) {
  session_start();
  $user_id = $_SESSION['user_id'];

  $title = $_POST['post-title'];
  $content = $_POST['post-content'];

  $image_data = null;
  if (isset($_FILES['post-image']) && $_FILES['post-image']['error'] === UPLOAD_ERR_OK) {
    $image_data = mysqli_real_escape_string($conn, file_get_contents($_FILES['post-image']['tmp_name']));
  }

  $sql = "INSERT INTO wpisy (autor_id, tytul, tresc, obrazek) VALUES ('$user_id', '$title', '$content', '$image_data')";

  if (mysqli_query($conn, $sql)) {
    header('Location: notify.php?info=post_added');
    exit;
  } else {
    header('Location: notify.php?info=post_error');
    exit;
  }
}

mysqli_close($conn);

            </code>
          </pre>
          </section>
          <br />
          <br />
          <section class="post" id="sekcja10">
            <h2>Rejestracja użytkownika</h2>
            <pre>
            <code class="language-php">
require_once("../php/connect.php");

$nickname = $_POST['nickname'] ?? '';
$email = $_POST['email'] ?? '';
$password = $_POST['password'] ?? '';
$Policy = $_POST['privacyPolicy'];

if (!filter_var($email, FILTER_VALIDATE_EMAIL) || !$Policy) {
  $queryParams = http_build_query([
    'error' =&gt; (!filter_var($email, FILTER_VALIDATE_EMAIL)) ? 'invalid_email' : 'accept_policy',
    'nickname' =&gt; $nickname,
    'email' =&gt; $email
  ]);

  header("Location: register.php?$queryParams");
  exit;
}

$result = mysqli_query($conn, "SELECT * FROM uzytkownicy WHERE email = '$email' OR nickname = '$nickname'");

if (mysqli_fetch_row($result) &gt; 0) {
  $queryParams = http_build_query([
    'error' =&gt; 'user_exists',
    'nickname' =&gt; $nickname,
    'email' =&gt; $email
  ]);

  header("Location: register.php?$queryParams");
  exit;
}
$hashedPass = password_hash($password, PASSWORD_DEFAULT);

if (mysqli_query($conn, "INSERT INTO uzytkownicy (nickname, email, haslo) VALUES ('$nickname', '$email', '$hashedPass')")) {
  $password = $hashedPass = '';
  header('Location: login.php');
  exit;
}
header('Location: register.php?error=register_failed');
exit;

            </code>
          </pre>
          </section>
          <br />
          <br />
          <section class="post" id="sekcja11">
            <h2>Resetowanie hasła</h2>
            <pre>
            <code class="language-php">
require_once("../php/connect.php");

$email = $_POST['email'];
$pass = $_POST['password'];
$hashedPass = password_hash($pass, PASSWORD_DEFAULT);

if (!isset($email)) {
  session_start();

  $user_id = $_SESSION['user_id'];
  $result = mysqli_query($conn, "SELECT user_id FROM uzytkownicy WHERE user_id = '$user_id'");

  if (mysqli_num_rows($result) &gt; 0) {
    $sql = "UPDATE uzytkownicy SET haslo = '$hashedPass' WHERE user_id = '$user_id'";
    if (mysqli_query($conn, $sql)) {
      header("Location: notify.php?info=change_success");
      exit;
    }
    header("Location: notify.php?info=change_failed");
    exit;
  }
  header("Location: notify.php?info=invalid_user_id");
  exit;
}

$result = mysqli_query($conn, "SELECT email FROM uzytkownicy WHERE email = '$email'");

if (mysqli_num_rows($result) &gt; 0) {
  $sql = "UPDATE uzytkownicy SET haslo = '$hashedPass' WHERE email = '$email'";
  if (mysqli_query($conn, $sql)) {
    header("Location: login.php?success=change_success");
    exit;
  }
  header("Location: reset.php?error=invalid_email");
  exit;
}
header("Location: reset.php?error=invalid_email");
exit;

            </code>
          </pre>
          </section>
          <br />
          <br />
          <section class="post" id="sekcja12">
            <h2>Zapisz nowe dane</h2>
            <pre>
            <code class="language-php">
require_once("../php/connect.php");

$nickname = $_POST['settings-nick'];
$email = $_POST['settings-email'];

if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
  redirectToProfileWithError('invalid_email');
}

session_start();
$id = $_SESSION['user_id'];

$sql = "UPDATE uzytkownicy SET nickname = '$nickname', email = '$email' WHERE uzytkownicy.user_id = '$id'";

if (!mysqli_query($conn, $sql)) {
  redirectToProfileWithError('change_failed');
}

redirectToProfileWithError('change_success');

function redirectToProfileWithError($error)
{
  header("Location: profile-data.php?error=$error");
  exit;
}

            </code>
          </pre>
          </section>
          <br />
          <br />
          <section class="post" id="sekcja13">
            <h2>deleteAccount</h2>
            <pre>
            <code class="language-php">
require_once("../php/connect.php");

session_start();
$userId = $_SESSION['user_id'];

$sql = "DELETE FROM uzytkownicy, wpisy, komentarze
        USING uzytkownicy
        LEFT JOIN wpisy ON uzytkownicy.user_id = wpisy.autor_id
        LEFT JOIN komentarze ON uzytkownicy.user_id = komentarze.autor_id
        WHERE uzytkownicy.user_id = $userId";

$result = mysqli_query($conn, $sql);
if (!$result) {
  header("Location: notify.php?info=account_error");
}

session_unset();
session_destroy();

setcookie('login_cookie', '', time() - 3600 * 7, '/');

mysqli_close($conn);

            </code>
          </pre>
          </section>
          <br />
          <br />
        </div>
      </main>

      <footer>
        <p
          >&copy; Copyright 2023 by
          <span><a href="https://github.com/ItzLimak"> Kamil Popiołek</a></span></p
        >
      </footer>
    </div>

    <div id="cookies">
      <p
        >Strona wykorzystuje pliki cookies. Klikając "<b>Akceptuję</b>", zgadzasz się na ich
        użycie.</p
      >
      <button id="accept"><b>Akceptuję</b></button>
    </div>

    <script>
      Prism.highlightAll();
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="./assets/prism/prism.js"></script>
    <script src="./js/user-content.js"></script>
    <script src="./js/smooth-scroll.js"></script>
    <script src="./js/cookies.js"></script>
  </body>
</html>
